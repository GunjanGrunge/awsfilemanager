version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install
    build:
      commands:
        - echo "Building with environment variables"
        - node -e "console.log('AWS_BUCKET_NAME:', process.env.AWS_BUCKET_NAME)"
        - >
          REACT_APP_CONFIG=$(cat << EOF
          {
            "AWS_REGION": "${AWS_REGION}",
            "AWS_ACCESS_KEY_ID": "${AWS_ACCESS_KEY_ID}",
            "AWS_SECRET_ACCESS_KEY": "${AWS_SECRET_ACCESS_KEY}",
            "AWS_BUCKET_NAME": "${AWS_BUCKET_NAME}",
            "FIREBASE_CONFIG": {
              "apiKey": "${FIREBASE_API_KEY}",
              "authDomain": "${FIREBASE_AUTH_DOMAIN}",
              "projectId": "${FIREBASE_PROJECT_ID}",
              "storageBucket": "${FIREBASE_STORAGE_BUCKET}",
              "messagingSenderId": "${FIREBASE_MESSAGING_SENDER_ID}",
              "appId": "${FIREBASE_APP_ID}"
            }
          }
          EOF
          )
        - echo $REACT_APP_CONFIG > ./src/config.json
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
